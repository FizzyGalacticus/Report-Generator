#ifndef MALWARE_WINDOW_CPP
#define MALWARE_WINDOW_CPP
#include "mainwindow.h"
#include <QHBoxLayout>
#include <QVBoxLayout>

void MainWindow::_setupMalwareWindow()
{
    //Main Malware Window
    _malwareWindow = new QDialog(this);
    _malwareWindow->setWindowTitle("Malware");
    _malwareWindow->setMinimumSize(560,333);
    _malwareWindow->setFocusPolicy(Qt::StrongFocus);

    //Malware List View
    _setupMalwareListView();

    //Accept Button
    _malwareWindowAcceptButton = new QPushButton(_malwareWindow);
    _malwareWindowAcceptButton->setText("Accept");
    _malwareWindowAcceptButton->setMaximumSize(50,25);
    connect(_malwareWindowAcceptButton,SIGNAL(clicked()),this,SLOT(_malwareWindowAcceptButtonHasBeenClicked()));

    //Malwarebytes
    _removedWithMalwarebytesInput = new QLineEdit(_malwareWindow);
    _removedWithMalwarebytesInput->setValidator(new QIntValidator(_malwareWindow));
    _removedWithMalwarebytesInput->setText("How many objects were removed with MalwareBytes?");
    _removedWithMalwarebytesInput->setCursorPosition(0);
    _removedWithMalwarebytesInput->show();

    //Avast
    _removedWithAvastInput = new QLineEdit(_malwareWindow);
    _removedWithAvastInput->setValidator(new QIntValidator(_malwareWindow));
    _removedWithAvastInput->setText("How many objects were removed with Avast?");
    _removedWithAvastInput->setCursorPosition(0);
    _removedWithAvastInput->show();

    _malwareWindow->show();


    _removedWithMalwarebytesInput->selectAll();
    _removedWithMalwarebytesInput->setFocus();

    QHBoxLayout * mainLayout = new QHBoxLayout;
    QVBoxLayout * antiVirusLayout = new QVBoxLayout;

    antiVirusLayout->addWidget(_removedWithMalwarebytesInput);
    antiVirusLayout->addWidget(_removedWithAvastInput);
    antiVirusLayout->addWidget(_malwareWindowAcceptButton);

    mainLayout->addWidget(_malwareListView);
    mainLayout->addLayout(antiVirusLayout);
    _malwareWindow->setLayout(mainLayout);
}

void MainWindow::_malwareButtonHasBeenClicked()
{
    this->hide();
    _setupMalwareWindow();
}

void MainWindow::_malwareWindowAcceptButtonHasBeenClicked()
{
    if(_removedWithMalwarebytesInput->text() != "How many objects were removed with MalwareBytes?") _removedWithMalwarebytes = _removedWithMalwarebytesInput->text().toInt();
    if(_removedWithAvastInput->text() != "How many objects were removed with Avast?") _removedWithAvast = _removedWithAvastInput->text().toInt();
    delete _malwareWindow;
    _generateReport();
    this->show();
}

void MainWindow::_setupMalwareListView()
{
    _malwareListView = new QListWidget(_malwareWindow);

    vector<string> malwarelist = getStringListFromFile("malware");

    for(unsigned int i = 0; i < malwarelist.size(); i++)
    {
        _malwareListView->addItem(QString(malwarelist[i].c_str()));
        _malwareListView->item(i)->setTextColor("Black");
    }

    for(int i = 0; i < _currentlySelectedMalware->count(); i++)
        for(int j = 0; j < _malwareListView->count(); j++)
            if(_currentlySelectedMalware->at(i) == _malwareListView->item(j)->text())
                _malwareListView->item(j)->setTextColor("Red");

    _malwareListView->addItem("Add Item");
    connect(_malwareListView,SIGNAL(itemDoubleClicked(QListWidgetItem*)),this,SLOT(_malwareListViewItemHasBeenDoubleClicked(QListWidgetItem*)));

    _malwareListView->show();
}

void MainWindow::_malwareListViewItemHasBeenDoubleClicked(QListWidgetItem *item)
{
    if(item != _malwareListView->item(_malwareListView->count()-1))
    {
        if(_currentlySelectedMalware->contains(item->text()))
        {
            item->setTextColor("Black");
            _currentlySelectedMalware->removeAt(_currentlySelectedMalware->indexOf(item->text()));
        }
        else
        {
            item->setTextColor("Red");
            _currentlySelectedMalware->append(item->text().toStdString().c_str());
        }

        _currentlySelectedMalware->sort();
    }
    else
    {
        string malware = getUserInputString(_malwareWindow,"Removed Malware","Removed Malware:").toStdString();
        if(malware.size())
        {
            appendLineToFile(tr("malware"),tr(malware.c_str()));
            _malwareListView->item(_malwareListView->count()-1)->setText(QString(malware.c_str()));

            _malwareListView->sortItems();
            _malwareListView->show();

            for(int i = 0; i < _malwareListView->count(); i++)
                if(_malwareListView->item(i)->text() == QString(malware.c_str()))
                {
                    _malwareListView->setItemSelected(_malwareListView->item(i), true);
                    _malwareListView->item(i)->setTextColor("Red");
                    _currentlySelectedMalware->append(_malwareListView->item(i)->text().toStdString().c_str());
                    break;
                }

            _malwareListView->addItem(QString("Add Item"));
            _malwareListView->item(_malwareListView->count()-1)->setTextColor("Black");
        }
    }
}

#endif
